<!DOCTYPE html>
<html>
<head>
  <title>Twitch Word Tracker</title>
</head>
<body>
  <h1>Twitch Word Tracker</h1>
  <label>Channel: <input type="text" id="channel"></label><br>
  <label>Target Word: <input type="text" id="word"></label><br>
  <button onclick="startTracking()">Start</button>
  <h2>Points: <span id="points">0</span></h2>
  <h3>Next word in: <span id="cooldown">0</span>s</h3>
  <h2>Chat</h2>
  <div id="chat" style="border:1px solid #ccc; height:200px; overflow-y:scroll;"></div>
  <h2>Top Words (last 10s)</h2>
  <table id="wordTable" border="1">
    <thead><tr><th>Word</th><th>Count</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
    setInterval(() => {
      const remaining = Math.max(0, 10 - Math.floor((Date.now() - lastSubmitTime) / 1000));
      document.getElementById('cooldown').textContent = remaining;
    }, 200);

    let lastSubmitTime = 0;
    function startTracking() {
      const now = Date.now();
      if (now - lastSubmitTime < 10000) return;

      const channel = document.getElementById('channel').value;
      const word = document.getElementById('word').value;
      fetch('/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ channel, word })
      }).then(res => {
        if (res.ok) {
          lastSubmitTime = Date.now();
        }
      });
    }

    const pointSource = new EventSource('/points');
    pointSource.onmessage = (e) => {
      document.getElementById('points').textContent = e.data;
    };

    const chatSource = new EventSource('/chat');
    chatSource.onmessage = (e) => {
      const chatDiv = document.getElementById('chat');

      const word = document.getElementById('word').value.toLowerCase();
      const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const re = new RegExp(`(${escapedWord})`, 'gi');
      const highlighted = e.data.replace(re, '<mark>$1</mark>');
      chatDiv.innerHTML += `<div>${highlighted}</div>`;

      chatDiv.scrollTop = chatDiv.scrollHeight;
    };

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') startTracking();
    });

    const wordSource = new EventSource('/words');
    wordSource.onmessage = (e) => {
      const table = document.querySelector('#wordTable tbody');
      const data = JSON.parse(e.data);
      table.innerHTML = '';
      data.forEach(([word, count]) => {
        table.innerHTML += `<tr><td>${word}</td><td>${count}</td></tr>`;
      });
    };
  </script>
</body>
</html>

